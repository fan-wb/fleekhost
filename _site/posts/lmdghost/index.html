<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="以太坊 PoS 共识协议详解（一）：核心概念与 LMD GHOST" />
<meta property="og:locale" content="en" />
<meta name="description" content="本文是介绍以太坊 PoS 共识协议的第一部分。主要包括对术语和核心概念的讲解，以及对 LMD GHOST 分叉选择规则的详细介绍。" />
<meta property="og:description" content="本文是介绍以太坊 PoS 共识协议的第一部分。主要包括对术语和核心概念的讲解，以及对 LMD GHOST 分叉选择规则的详细介绍。" />
<link rel="canonical" href="https://fan-wb.github.io/posts/lmdghost/" />
<meta property="og:url" content="https://fan-wb.github.io/posts/lmdghost/" />
<meta property="og:site_name" content="Fanwb’s Blog" />
<meta property="og:image" content="https://fanwb.oss-cn-beijing.aliyuncs.com/img/MV5BYWQ2NDIxYTQtYWMyNC00MmRlLWExMDMtOWYwODVjM2Y4MTRhXkEyXkFqcGdeQXVyNjc3OTE4Nzk.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-15T12:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://fanwb.oss-cn-beijing.aliyuncs.com/img/MV5BYWQ2NDIxYTQtYWMyNC00MmRlLWExMDMtOWYwODVjM2Y4MTRhXkEyXkFqcGdeQXVyNjc3OTE4Nzk.jpg" />
<meta property="twitter:title" content="以太坊 PoS 共识协议详解（一）：核心概念与 LMD GHOST" />
<meta name="twitter:site" content="@twitter_username" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-26T21:14:47+08:00","datePublished":"2023-04-15T12:00:00+08:00","description":"本文是介绍以太坊 PoS 共识协议的第一部分。主要包括对术语和核心概念的讲解，以及对 LMD GHOST 分叉选择规则的详细介绍。","headline":"以太坊 PoS 共识协议详解（一）：核心概念与 LMD GHOST","image":"https://fanwb.oss-cn-beijing.aliyuncs.com/img/MV5BYWQ2NDIxYTQtYWMyNC00MmRlLWExMDMtOWYwODVjM2Y4MTRhXkEyXkFqcGdeQXVyNjc3OTE4Nzk.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://fan-wb.github.io/posts/lmdghost/"},"url":"https://fan-wb.github.io/posts/lmdghost/"}</script>
<!-- End Jekyll SEO tag -->


  <title>以太坊 PoS 共识协议详解（一）：核心概念与 LMD GHOST | Fanwb's Blog
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Fanwb's Blog">
<meta name="application-name" content="Fanwb's Blog">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    
      <link rel="preconnect" href="https://cdnjs.cloudflare.com" >
      <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  
    <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }
          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();
      });
    } /* constructor() */

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get isLightMode() {
      return this.mode === ModeToggle.LIGHT_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }
        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }
      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    } /* flipMode() */
  } /* ModeToggle */

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/微信图片_20240125105358.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">Fanwb's Blog</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">The Revolution Will Be Decentralized.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tag"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/test/" class="nav-link">
            <i class="fa-fw fas fa-ghost"></i>
            

            <span>TEST</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
        <a
          href="https://github.com/fan-wb"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/twitter_username"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-square-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['fanwb.eth','outlook.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>以太坊 PoS 共识协议详解（一）：核心概念与 LMD GHOST</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>以太坊 PoS 共识协议详解（一）：核心概念与 LMD GHOST</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1681531200"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Apr 15, 2023
</time>

      </span>

      <!-- lastmod date -->
      
        <span>
          Updated
          <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1732626887"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Nov 26, 2024
</time>

        </span>
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/MV5BYWQ2NDIxYTQtYWMyNC00MmRlLWExMDMtOWYwODVjM2Y4MTRhXkEyXkFqcGdeQXVyNjc3OTE4Nzk.jpg" class="popup img-link preview-img shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/MV5BYWQ2NDIxYTQtYWMyNC00MmRlLWExMDMtOWYwODVjM2Y4MTRhXkEyXkFqcGdeQXVyNjc3OTE4Nzk.jpg"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              <a href="https://github.com/fan-wb">Fan-WB</a>
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="7651 words"
>
  <em>42 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <p>本文是介绍以太坊 PoS 共识协议的第一部分。主要包括对术语和核心概念的讲解，以及对 LMD GHOST 分叉选择规则的详细介绍。</p>

<h2 id="术语及重要概念"><span class="me-2">术语及重要概念</span><a href="#术语及重要概念" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="节点和验证者"><span class="me-2">节点和验证者</span><a href="#节点和验证者" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>以太坊网络的主要参与者是<strong>节点</strong> (Node)。节点的作用是验证共识并与其他节点形成通信骨干网。共识由<strong>验证者</strong> (Validator) 形成。</p>

<blockquote class="prompt-info">
  <p>“验证者”这一术语具有一定的误导性，验证者其实并不会验证任何东西，验证是由节点完成的。</p>
</blockquote>

<p>每个验证者代表一笔初始的 32 ETH 的质押。验证者有自己的私钥，以及与其对应的公钥，代表其在协议中的身份。验证器附属于节点，单个节点可以托管零到数百甚至数千个验证者，附属于同一节点的验证者共享相同的全局视图。 <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p>

<p>权益见证与工作量见证的一个重要区别在于，在权益见证下验证者集是已知的，系统拥有在任意时刻期望处于活跃状态的公钥的完整列表。由此我们可以确定何时获得了参与者的多数票，并达成最终性。</p>

<h3 id="slot-和-epoch"><span class="me-2">Slot 和 Epoch</span><a href="#slot-和-epoch" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>以太坊的权益见证共识中，时间是被精确控制的，这与工作量见证截然不同，后者只是尝试在平均水平上保持出块间隔不变，仅此而已。</p>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/c9bf6b46-0344-44f6-8553-b1238b8399c9.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/c9bf6b46-0344-44f6-8553-b1238b8399c9.png" style="zoom:110%;" loading="lazy"></a>
<em>图1 前 32 个 Slot 属于第 0 个 Epoch，创世块位于第 0 个 Slot</em></p>

<p><strong>Slot</strong>（常译作“时隙”、“区块槽”）和 <strong>Epoch</strong>（常译作“时段”）是划分时间的两个主要概念，每个 Slot 为 12 秒，每个 Epoch 为 32 个 Slot，即 6.4 分钟。无论网络上情况如何，Slot 和 Epoch 都会保持节奏持续向前推进。</p>

<h3 id="区块和见证"><span class="me-2">区块和见证</span><a href="#区块和见证" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>每个 Slot 会选出<strong>一名</strong>验证者提议一个<strong>区块</strong> (Block)。区块包含对信标状态的更新，其中包括提议者知道的<strong>见证</strong> (Attestation) 以及带有以太坊用户交易的执行负载。提议者通过 Gossip 协议与整个网络共享其区块。</p>

<p>Slot 可以为空：因为区块提议者可能处于离线状态，或者提议了一个无效的区块，或者其区块随后被链重组 (Reorg) 剔除出链。</p>

<p>每个 Epoch 中，每个验证者都能以见证的形式分享一次自己的视图。见证包含用于 LMD GHOST 协议的<strong>链头</strong>投票以及用于 Casper FFG 协议的<strong>检查点</strong>投票。见证也会广播到整个网络。见证和区块一样，也可能由于各种原因丢失，并且协议可以在一定程度上容忍这种情况。粗略地说，随着见证者参与率的下降，共识的质量将会下降。 <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p>

<p>Epoch 的功能是分散处理所有这些见证的负载。通过见证，每个验证者都会将自己的全局视图告知其他每个验证者，如果所有操作都同时进行，可能带来巨量的网络流量和处理负载。将见证负载分散到一个 Epoch 的 32 个 Slot 中可以保持较低的资源使用率。在每个 Slot 中，仅由$ \frac{1}{32} $的验证者组成的委员会进行见证。</p>

<p>协议通过奖励和罚没系统激励验证者进行区块和见证的生产并确保其准确性，这一部分本文暂不深入探讨。</p>

<h3 id="安全性和活性"><span class="me-2">安全性和活性</span><a href="#安全性和活性" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>在讨论共识机制时，经常会用到两个重要概念：<strong>安全性</strong> (Safety) 和<strong>活性</strong> (Liveness)。</p>

<p>用一句话概括安全性要求就是“永不发生坏事”。在区块链语境下，“坏事”可能是币的双花，或冲突检查点的最终化等。</p>

<p>分布式系统中安全性的一个重要方面是“一致性 (Consistency)”。也就是说，如果我们向不同的节点查询链的状态（如特定区块高度的账户余额），则无论询问哪个节点，都应该始终得到相同的答案。在一个安全的系统中，每个节点对链的历史都具有完全相同的视图，并且该视图永远不会改变。安全性意味着我们的分布式系统“<a href="https://www.scs.stanford.edu/nyu/03sp/sched/bfs.pdf">像中心化实现一样原子地执行每一步操作</a>”。根据 Vitalik 的中心化<a href="https://medium.com/@VitalikButerin/the-meaning-of-decentralization-a0c92b76a274">分类法</a>，安全的系统在逻辑上是中心化的。</p>

<p>而同样用一句话概括活性就是“终会发生好事”。在区块链语境中，通常可以理解为链可以始终添加新块，永远不会陷入死锁状态。</p>

<p>也可以从“可用性 (Availability)”的角度出发理解活性：链是可用的，意味着如果我向诚实节点发送有效交易，最终交易一定会被包含在一个扩展链的区块中。</p>

<p>值得注意的是，CAP 定理证明了没有分布式系统可以同时满足：一致性，可用性和分区容错性。现实中，我们只能基于<strong>不可靠</strong>的互联网构建区块链，即分区容错性是必须成立的，这也就说明链的安全性和活性是<strong>难以两全</strong>的。以太坊共识协议在网络状况良好时能同时提供安全性和活性，但在运行不顺利的情况下优先考虑活性。在网络分区的情况下，分区两侧的节点都将继续产生区块，但最终性（安全属性）不再有保障。具体取决于各分区中的质押权益比例，可能只有一侧继续最终化，也可能双方都无法最终化。最终，除非分区问题得到解决，否则消极惩罚机制 (Inactivity Leak) 会使双方都将重新获得最终性，但同时也将导致共识的撕裂，两条链将最终化不同的历史记录，并且这两条链将永远保持独立，无法调和。</p>

<h3 id="罚没"><span class="me-2">罚没</span><a href="#罚没" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>在工作量证明中，产生区块代价很高。这会激励矿工按照协议的目标正当行事，以确保其区块被包含。</p>

<p>而在权益见证中，创建区块和见证的成本近乎为零<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup>，我们需要一种方法来防止攻击者利用这一点扰乱网络。这就是<strong>罚没</strong> (Slashing) 的作用。对区块或见证有分歧行为的验证者会受到罚没，即被驱逐出验证者集并被没收部分质押金。这里的分歧行为的意思简单来说就是自相矛盾，例如为同一个 Slot 提议两个不同的区块，或做出两个相互冲突的见证等遵循协议的诚实验证者不会做出的行为。</p>

<h2 id="ghost-in-the-shell"><span class="me-2">Ghost in the Shell</span><a href="#ghost-in-the-shell" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>了解术语和核心概念后，本节将概述以太坊的实际共识机制。</p>

<p>以太坊的权益证明共识协议实际上是两个独立的共识协议的组合，分别称为 <strong>LMD GHOST</strong> 和 <strong>Casper FFG</strong>，二者组合的协议有时被称为“<strong>Gasper</strong>”。</p>

<p>Gasper 中将两者结合，试图在活性和安全性方面获得两全其美的效果。从本质上讲，LMD GHOST 提供了逐区块的活性（保持链的运行），而 Casper FFG 提供了安全性（保护链免于长回滚）。LMD GHOST 允许我们不断地生成区块，但它存在分叉，因此在形式上并不安全。Casper FFG 修改了 LMD GHOST 的分叉选择规则，以期定期为链提供最终性。然而，如前所述，以太坊优先考虑活性。因此，在 Casper FFG 无法提供最终性的情况下，链仍然会通过 LMD GHOST 机制继续增长。</p>

<p>这种“拼凑”在一起的共识机制并不完美，但秉承以太坊的精神来看，这是一种可行的工程解决方案，在实践中能很好地达成目的。</p>

<h3 id="历史"><span class="me-2">历史</span><a href="#历史" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Gasper 的详细历史与其组件（LMD GHOST 和 Casper FFG）的发展紧密相关，我们将在后续文章中进行回顾。</p>

<p>在此要指出的是，Casper FFG 从来就不是设计成独立的共识机制。正如 <a href="https://arxiv.org/abs/1710.09437">Casper FFG 论文</a>中所述：</p>

<blockquote>
  <p>“Casper the Friendly Finality Gadget” 是提案机制（提出区块的机制）之上的一个覆盖层。</p>
</blockquote>

<p>因此，Casper FFG 之下还存在着一个底层的区块提议机制（说明存在底层共识机制）提供了某种“元共识”，赋予区块链最终性。</p>

<p>最初的计划是将 Casper FFG 作为权益证明覆盖层应用于以太坊的工作量证明共识之上。Casper FFG 将周期性地为链提供最终性（PoW 链缺少的属性）。旨在成为以太坊逐步淘汰工作量证明铺路，有了最终性保证，就可以减少工作量证明区块奖励，从而降低总哈希算力，为用权益证明取代挖矿做准备。到 2017 年底，<a href="https://eips.ethereum.org/EIPS/eip-1011">EIP-1011</a>（混合 Casper FFG）详细描述了架构，甚至还有一个测试网在 2017 年 12 月 31 日上线。然而以太坊虚拟机的有限带宽限制了 EIP-1011 可以支持的验证者集大小，进而导致最低质押额高达 1500 ETH，被认为是不可取的，因此该计划在 2018 年初被取代了。大约在同一时间，开发者们开始着手设计以太坊 2.0 协议。Casper FFG 的通用性使其在重新设计中得以被保留，作为新权益证明协议 LMD GHOST 的覆盖层，被采纳为以太坊 2.0 的一部分。</p>

<h3 id="最终性小工具"><span class="me-2">最终性小工具</span><a href="#最终性小工具" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>前文提到 Casper FFG “<strong>覆盖</strong>”现有区块提议机制时，其含义是 Casper FFG 使用现有的<strong>区块树</strong>并以特定方式进行<strong>剪枝</strong>，通过使某些分支不可访问来修改底层区块树的分叉选择。</p>

<p>考虑下面这个由某种底层共识机制（无论是工作量证明还是权益证明中的 LMD GHOST）产生的区块树：</p>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/eth2book.info_capella_part2_consensus_overview_.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/eth2book.info_capella_part2_consensus_overview_.png" alt="" loading="lazy"></a>
<em>由三个分叉组成的任意区块树 区块 I、E 或 M 都可以是链头（块标签仅为方便起见，并不表示特定顺序）</em></p>

<p>在这种情况下，有三个候选头块，I、E 和 M。在工作量证明最长链规则下，必须选择块 M 作为链头，因为它具有最大的区块高度，或者说该分支积累了最大的工作量。在 LMD GHOST 下，仅凭此信息无法选择头块，我们需要查看其他验证者的投票才能做出选择。</p>

<p>问题在于从区块 J 到 M 的链可能来自攻击者。攻击者可能秘密挖矿了该链随后在 51% 攻击中揭示。PoW 节点别无选择，只能重组链以使 M 成为头块，这有利于攻击者的链并可能受到双花攻击。</p>

<p>Casper FFG 带来的价值在于赋予最终性。假设 Casper FFG 将区块 D 标记为最终化（这也会自动将区块 A、B 和 C 标记为最终化）。最终化会修改底层协议的分叉选择规则，因此任何包含与区块 D 竞争的区块（即不是 D 的子孙的区块）的分支都会被排除在外。相当于修剪分支来确保最终化的区块之前没有分叉。</p>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/eth2book.info_capella_part2_consensus_overview_1.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/eth2book.info_capella_part2_consensus_overview_1.png" alt="" loading="lazy"></a>
<em>与上面相同的区块树，但区块 D 已被最终化 Casper FFG 分叉选择规则指出，任何不包含区块 D 的链都会被忽略，因此头块明确是 E</em></p>

<p>本质上，Casper FFG 提供的最终性可以防止长重新（回滚）。任何最终化区块及最终化区块的祖先区块都将永远不会被回滚。在以太坊的 Casper FFG 实现中，“永远”被限定在“不销毁质押以太坊总量的三分之一”的条件下。这就是 PoS 链所提供的<strong>经济最终性</strong>。</p>

<h2 id="lmd-ghost"><span class="me-2">LMD-GHOST</span><a href="#lmd-ghost" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>在本节中，我们将单独探讨 LMD GHOST，忽略 Casper FFG 最终性叠加层。 与 Nakamoto 共识中的最长链规则一样，LMD GHOST 也是一种分叉选择规则，是共识机制的核心，有着自己的一套属性和权衡取舍。本文会先介绍其原理，后续文章将深入探讨可能存在的问题。</p>

<h3 id="命名"><span class="me-2">命名</span><a href="#命名" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>LMD GHOST 这个名称由两个缩写词组成，”Latest Message Driven”（<strong>最新消息驱动</strong>）和 “Greedy Heaviest-Observed Sub-Tree”（<strong>贪婪最重观测子树</strong>）。</p>

<p><strong>GHOST</strong></p>

<p>GHOST 协议来自 Sompolinsky 和 Zohar 在 2013 年的一篇<a href="https://eprint.iacr.org/2013/881">论文</a>，该论文讨论了如何在比特币上安全地提高交易吞吐量。增加区块大小或缩短区块间隔会使区块链在延迟不受控的网络中（例如互联网）更容易分叉。分叉的链会发生更多重组，而重组会损害交易安全性。用 GHOST 分叉选择规则替换比特币最长链分叉选择规则被证明在存在延迟的条件下更加稳定，能使出块更加频繁。</p>

<p>GHOST 代表了 “Greedy Heaviest-Observed Sub-Tree”（贪婪最重观测子树），这也是对算法工作原理的描述，后文将详细解释。简而言之，GHOST 的分叉选择并不遵循最长链，而是遵循最重的子树。算法认识到对区块的投票不单是投给该区块的，而是隐含了对其所有祖先区块的投票，因此整个子树都应具有相关的权重。</p>

<p><strong>LMD</strong></p>

<p>以太坊权益证明中使用的 GHOST 协议已经扩展到能够处理见证。在工作量证明中，投票者是区块提议者。他们通过在其之上构建自己的区块来对分支进行投票。而在权益证明协议中，所有验证者都是投票者，每个验证者平均每 6.4 分钟通过发布见证来对其网络视图进行一次投票。因此，在 PoS 下，我们会拥有更多关于参与者网络视图的信息。</p>

<p>这就是“<strong>消息驱动</strong>”的含义，也就是 LMD 中的 MD。分叉选择不是由提议者添加的区块驱动的，而是由所有验证者发布的<strong>消息</strong>（见证、投票）驱动的。</p>

<p>“L” 代表 “latest”（最新）：LMD GHOST 只考虑来自每个验证者的<strong>最新</strong>消息，即从该验证者收到的最近的见证。验证者所有早期的消息都会被丢弃，但其最新投票会被保留并无限期地具有权重。</p>

<h3 id="原理"><span class="me-2">原理</span><a href="#原理" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>LMD GHOST 首先是一个分叉选择规则。给定一个区块树和一系列投票，LMD GHOST 会告诉节点应该将哪个区块视为链头，节点可以从该块一直回溯到创世块，获得线性的历史视图。这一选择基于节点接收到的消息（区块和见证）所形成的对链的<strong>本地视图</strong>。没有“上帝视图”，节点只能依赖其本地视图，该视图可能与其他节点的本地视图大不相同。重点在于是诚实的验证者会基于他们看到的链头来构建区块，并且会根据看到的链头投票。</p>

<p>对 LMD GHOST 原理的介绍将分两部分进行，首先说明 LMD 部分（最新消息），随后是 GHOST 部分（确定链头）。</p>

<h4 id="最新消息"><span class="me-2">最新消息</span><a href="#最新消息" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>在此语境下，消息是指见证中的链头投票。</p>

<p><strong>LMD GHOST 中的投票</strong></p>

<p>在见证的 data 中，链头投票是 <code class="language-plaintext highlighter-rouge">beacon_block_root</code> 字段：</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">AttestationData</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">slot</span><span class="p">:</span> <span class="n">Slot</span>
    <span class="n">index</span><span class="p">:</span> <span class="n">CommitteeIndex</span>
    <span class="c1"># LMD GHOST 投票
</span>    <span class="n">beacon_block_root</span><span class="p">:</span> <span class="n">Root</span>
    <span class="c1"># FFG 投票
</span>    <span class="n">source</span><span class="p">:</span> <span class="n">Checkpoint</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Checkpoint</span>
</pre></td></tr></tbody></table></code></div></div>

<p>每个诚实的验证者在每个 Epoch 恰好进行一次见证，其中包含对当时其视图中的最佳链头的投票。在每个 Epoch 内，验证者集会被分割，这样每个 Slot 只有$ \frac{1}{32} $的验证者进行见证。</p>

<p>节点通过两种方式接收见证：直接通过证明 Gossip 协议接收，以及间接地从区块内接收。</p>

<p><strong>存储最新消息</strong></p>

<p>无论通过何种方式接收见证，节点都会调用分叉选择规则的 <code class="language-plaintext highlighter-rouge">on_attestation()</code> handler。在继续之前，<code class="language-plaintext highlighter-rouge">on_attestation()</code> handler 会对见证执行一些基本的有效性检查：</p>

<ul>
  <li>
    <p>是否太旧？</p>

    <ul>
      <li>见证必须来自当前或前一个 Epoch。</li>
    </ul>
  </li>
  <li>
    <p>是否太新？</p>

    <ul>
      <li>见证必须不迟于上一个 Slot。</li>
    </ul>
  </li>
  <li>
    <p>是否知道该见证投票的区块 <code class="language-plaintext highlighter-rouge">beacon_block_root</code>？</p>

    <ul>
      <li>必须收到过该区块。如果没有，尝试从对等点处获取。</li>
    </ul>
  </li>
  <li>
    <p>见证的签名是否正确？</p>

    <ul>
      <li>验证者对见证进行签名并对其负责。</li>
    </ul>
  </li>
  <li>
    <p>见证是否可罚没？</p>

    <ul>
      <li>必须忽略与其他见证冲突的见证。</li>
    </ul>
  </li>
</ul>

<p>通过检查后，见证将被放入节点的 Store 中（Store 是节点对链视图信息的存储库），这一步由 <code class="language-plaintext highlighter-rouge">update_latest_messages()</code> 完成。</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">update_latest_messages</span><span class="p">(</span><span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">attesting_indices</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ValidatorIndex</span><span class="p">],</span> <span class="n">attestation</span><span class="p">:</span> <span class="n">Attestation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">target</span>
    <span class="n">beacon_block_root</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">beacon_block_root</span>
    <span class="n">non_equivocating_attesting_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">attesting_indices</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">store</span><span class="p">.</span><span class="n">equivocating_indices</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">non_equivocating_attesting_indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">store</span><span class="p">.</span><span class="n">latest_messages</span> <span class="ow">or</span> <span class="n">target</span><span class="p">.</span><span class="n">epoch</span> <span class="o">&gt;</span> <span class="n">store</span><span class="p">.</span><span class="n">latest_messages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">epoch</span><span class="p">:</span>
            <span class="n">store</span><span class="p">.</span><span class="n">latest_messages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nc">LatestMessage</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="n">target</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="n">beacon_block_root</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>如果本地没有存储该验证者的链头投票，则存储该见证和验证者信息。如果本地已存有该验证者的链头投票，若该见证更新，则进行替换。随着时间的推移，节点的 Store 会建立起一个列表，其中包含所有接收过的每个验证者的最新投票。</p>

<p>注意，节点只能存储在当前或前一个 Epoch 创建的投票，一旦投票进入 Store，就会无限期地被保留，并继续影响分叉选择，直到被替换为更新的投票为止。</p>

<h4 id="确定链头"><span class="me-2">确定链头</span><a href="#确定链头" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>本质上，LMD GHOST 分叉选择规则即函数 <code class="language-plaintext highlighter-rouge">GetHead(Store) → HeadBlock</code>。</p>

<p>如前所述，节点的 Store 就是其全局视图：节点接收到的所有可能影响分叉选择的相关信息。对于 LMD GHOST 算法而言， Store 中的相关部分如下：</p>

<ul>
  <li>区块树，实质是一个区块列表。区块的父链接将其在逻辑上连成了一个树。</li>
  <li>来自验证者的最新消息（投票）列表。</li>
  <li>验证者的有效余额，为算法提供了所需的权重。</li>
</ul>

<p>GHOST 算法的目标是从给定的区块树中选择单个叶块（即没有子孙块的区块）作为链头区块。</p>

<p>我们假设区块树中的所有区块都来自单个根区块。在纯 GHOST 算法中，根区块就是创世区块：根据定义，所有区块都来自创世区块。而在完整的共识实现中，根区块是最后一个已确认 (Justified) 的检查点区块。重点在于 GHOST 算法会从给定的区块开始，并会忽略所有不从该区块派生的区块。</p>

<p><strong>获取权重</strong></p>

<p>第一步要计算树中每个分支的“权重”。投票的权重是进行投票的验证者的有效余额，通常会是 32 ETH（最大有效余额），但也有可能更少。</p>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715173897383.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715173897383.png" alt="" loading="lazy"></a>
<em>$B_N$表示最新链头投票目标为区块$N$的验证者的有效余额之和，$W_N$表示以区块$N$为根的分支的权重</em></p>

<p>分支权重$W_x$ 和区块投票权重$B_x$之间有一些显而易见的联系：</p>

<ul>
  <li>对于仅包含叶块的分支 $L$，$W_L = B_L$。</li>
  <li>分支的权重等于其根块的投票权重与所有子分支权重之和。因此，在上图中，$W_1 = B_1 + W_2 + W_3$。</li>
  <li>分支的权重是形成该分支的子树中所有区块投票权重之和。</li>
</ul>

<p>由于投票的权重总是正的，因此根区块的权重最大，且等于树中所有区块投票权重之和。每个验证者最多只有一个最新消息（即一个投票），因此该权重上限为所有活跃验证者的总有效余额。</p>

<p><strong>获取链头</strong></p>

<p>计算出每个分支或子树的权重后，算法开始递归进行。给定一个区块，选择从中派生的最重分支。然后用该分支的根块重复该过程。如果两个或更多分支权重相等，选择根块哈希值最高的分支。最终算法输出一个叶块。</p>

<p>从 GHOST 这个名称可见，该算法：</p>

<ul>
  <li>是贪婪的，即立刻获取观测到的最重分支，不会进一步查看；</li>
  <li>处理子树，分支的权重是子树中所有区块投票权重之和。</li>
</ul>

<p>举例如下，图中包括：特定区块的投票权重（附加到每个区块的数字）和分支权重（块连线上的数字）。</p>

<ol>
  <li>根据存储器中的最新消息，我们计算树中每个区块的投票权重。</li>
</ol>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715219159424.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715219159424.png" alt="" loading="lazy"></a>
<em><code class="language-plaintext highlighter-rouge">get_head()</code>从区块树的根块 A 开始</em></p>

<ol>
  <li>根据每个区块的投票权重，计算每个分支或子树的权重。</li>
</ol>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715219465724.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715219465724.png" alt="" loading="lazy"></a>
<em><code class="language-plaintext highlighter-rouge">get_weight()</code> 函数应用于块时返回该块的子树及其所有后代的总权重</em></p>

<ol>
  <li>递归地遍历子树根块，始终选择权重最高的分支或子树。最终到达一个叶块，即算法选择的链头区块。</li>
</ol>

<p><a href="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715219687562.png" class="popup img-link  shimmer"><img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1715219687562.png" alt="" loading="lazy"></a>
<em>在块 A 时，分支 AC 最重 在块 C 时，分支 CE 最重 块 E 是叶块，因此是 GHOST 算法选出的链头区块 链为[A←C←E]</em></p>

<p>假如以 B 和 C 为根的子树权重相等，则选择 B 和 C 中哈希值更大的分支，这是完全随机的平局打破机制。</p>

<p>规范中实现以上功能的是 <code class="language-plaintext highlighter-rouge">get_head()</code>，它从根部向上遍历树，在每个分叉处取最重的分支。</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">get_head</span><span class="p">(</span><span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Root</span><span class="p">:</span>
    <span class="c1"># Get filtered block tree that only includes viable branches
</span>    <span class="n">blocks</span> <span class="o">=</span> <span class="nf">get_filtered_block_tree</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
    <span class="c1"># Execute the LMD-GHOST fork choice
</span>    <span class="n">head</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">justified_checkpoint</span><span class="p">.</span><span class="n">root</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">root</span> <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">.</span><span class="nf">keys</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">blocks</span><span class="p">[</span><span class="n">root</span><span class="p">].</span><span class="n">parent_root</span> <span class="o">==</span> <span class="n">head</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">head</span>
        <span class="c1"># Sort by latest attesting balance with ties broken lexicographically
</span>        <span class="c1"># Ties broken by favoring block with lexicographically higher root
</span>        <span class="n">head</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">root</span><span class="p">:</span> <span class="p">(</span><span class="nf">get_weight</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">root</span><span class="p">),</span> <span class="n">root</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></div></div>

<p>计算子树权重的是 <code class="language-plaintext highlighter-rouge">get_weight()</code>。实际的 <code class="language-plaintext highlighter-rouge">get_weight()</code>实现比上面介绍的更复杂一些，主要是因为 “proposer boost” 机制，这里暂不展开，后续文章将深入探讨。</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">get_weight</span><span class="p">(</span><span class="n">store</span><span class="p">:</span> <span class="n">Store</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">Root</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Gwei</span><span class="p">:</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">store</span><span class="p">.</span><span class="n">checkpoint_states</span><span class="p">[</span><span class="n">store</span><span class="p">.</span><span class="n">justified_checkpoint</span><span class="p">]</span>
    <span class="n">unslashed_and_active_indices</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="nf">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slashed</span>
    <span class="p">]</span>
    <span class="n">attestation_score</span> <span class="o">=</span> <span class="nc">Gwei</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span>
        <span class="n">state</span><span class="p">.</span><span class="n">validators</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">effective_balance</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unslashed_and_active_indices</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="n">store</span><span class="p">.</span><span class="n">latest_messages</span>
            <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">store</span><span class="p">.</span><span class="n">equivocating_indices</span>
            <span class="ow">and</span> <span class="nf">get_ancestor</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">latest_messages</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">root</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">root</span><span class="p">].</span><span class="n">slot</span><span class="p">)</span> <span class="o">==</span> <span class="n">root</span><span class="p">)</span>
    <span class="p">))</span>
    <span class="k">if</span> <span class="n">store</span><span class="p">.</span><span class="n">proposer_boost_root</span> <span class="o">==</span> <span class="nc">Root</span><span class="p">():</span>
        <span class="c1"># Return only attestation score if ``proposer_boost_root`` is not set
</span>        <span class="k">return</span> <span class="n">attestation_score</span>

    <span class="c1"># Calculate proposer score if ``proposer_boost_root`` is set
</span>    <span class="n">proposer_score</span> <span class="o">=</span> <span class="nc">Gwei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Boost is applied if ``root`` is an ancestor of ``proposer_boost_root``
</span>    <span class="k">if</span> <span class="nf">get_ancestor</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">proposer_boost_root</span><span class="p">,</span> <span class="n">store</span><span class="p">.</span><span class="n">blocks</span><span class="p">[</span><span class="n">root</span><span class="p">].</span><span class="n">slot</span><span class="p">)</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">committee_weight</span> <span class="o">=</span> <span class="nf">get_total_active_balance</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">//</span> <span class="n">SLOTS_PER_EPOCH</span>
        <span class="n">proposer_score</span> <span class="o">=</span> <span class="p">(</span><span class="n">committee_weight</span> <span class="o">*</span> <span class="n">PROPOSER_SCORE_BOOST</span><span class="p">)</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">attestation_score</span> <span class="o">+</span> <span class="n">proposer_score</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="小结"><span class="me-2">小结</span><a href="#小结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>了解了 GHOST 协议的工作原理后，可以更直观地看出其相较于最长链规则的优越性。分叉的出现表明块传播时间已经接近甚至超过了出块时间（Slot），因此并非所有验证者都能<strong>及时</strong>看到所有区块并进行见证。在这种情况下，需要利用可用的大量信息：对同一个父区块两个不同子区块的投票应该被理解为所有这些验证者都支持父区块的分支，仅对子区块存有分歧。GHOST 通过让子区块的投票为其所有祖先区块增加权重实现了这一点，选择时总会优先考虑验证者总支持最多的分支。而最长链规则会丢弃这些信息，一个分支即使只有少数验证者在处理也有可能胜出。</p>

<h3 id="激励机制"><span class="me-2">激励机制</span><a href="#激励机制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>加密经济系统保障自身安全的一种方式是“惩恶扬善”，即奖励正当行为并惩罚不良行为。在对 LMD GHOST 的实现中，提议者和验证者都会因正确找到链头而以不同的方式获得奖励。</p>

<p>区块提议者隐式地获得激励。如果不在最佳链头区块上构建，那么其区块很可能不会被包含在最终的规范链中，成为孤块，那么提议者将不会收到区块奖励。工作量证明中的矿工情况与之类似。</p>

<p>而当验证者进行了准确的链头投票，并且其见证在下个 Slot 的区块中被包含时，将直接获得奖励。理论上，完美运行的验证者能通过准确的链头投票获得其总协议激励的大约 22%。同时，提议者则被激励在区块中包含这样的证明。</p>

<p>这里投票“准确”的含义是投票与最终规范链中的内容一致。如果验证者的链头投票不准确，并不会受到惩罚。因为当链上压力较大，存在延迟和丢失的区块时，准确进行投票很困难，在这种情况下惩罚验证者是不公平的。</p>

<h3 id="罚没机制"><span class="me-2">罚没机制</span><a href="#罚没机制" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>权益证明设计的一大突破之一是采用罚没机制来解决 “<a href="https://ethereum.stackexchange.com/questions/2402/what-exactly-is-the-nothing-at-stake-problem">nothing at stake</a>” 问题。</p>

<h4 id="提议者罚没"><span class="me-2">提议者罚没</span><a href="#提议者罚没" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>当轮到某验证者在一个特定 Slot 中生成区块时，验证者应该运行分叉选择规则来决定基于哪个现有区块来构建自己的区块。其目标是根据自身拥有的信息，识别最有可能最终成为规范链的分叉，即正确验证者集将收敛到的那个分叉。</p>

<p>但与工作量证明不同，在权益证明下，验证者生成区块几乎没有成本。因此，最好的策略是为每个可能的链头都生成区块，其中有一个区块一定会成为最终规范链的一部分。</p>

<p>但这样的行为会延长分叉并阻止网络收敛到线性历史。用户可能无法确定哪个分叉是正确的，容易受到双花攻击。这就是 “nothing at stake” 问题。解决方案如前所述，是检测两个相互矛盾的区块并惩罚提议者。</p>

<p>提议者分歧行为不是在协议内部检测到的，而是依赖于第三方用 ProposerSlashing 对象的形式构建证明。</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">ProposerSlashing</span><span class="p">(</span><span class="n">Container</span><span class="p">):</span>
    <span class="n">signed_header_1</span><span class="p">:</span> <span class="n">SignedBeaconBlockHeader</span>
    <span class="n">signed_header_2</span><span class="p">:</span> <span class="n">SignedBeaconBlockHeader</span>
</pre></td></tr></tbody></table></code></div></div>

<p>该证明仅包含两个签名区块头，足以证明提议者在同一 Slot 中签署了两个区块。后续的区块提议者会将该证明包含在区块中（并获得丰厚的奖励），协议会罚没违规验证者的质押金并将其从活动验证者集中踢出。</p>

<h4 id="见证者罚没"><span class="me-2">见证者罚没</span><a href="#见证者罚没" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>当轮到某验证者发布见证时，验证者应该运行其分叉选择规则并投票给其视图中正确的链头区块。问题在于攻击者可以做出多个相互矛盾的见证来引发或延长分叉并阻止网络收敛到单个链。如果不罚没，那么这就会成为对投票错误错过奖励的对冲方式。</p>

<p>措施与上述相同：检测并罚没相互矛盾的见证（同一个验证者在同一个 Slot 中针对不同链头做出的见证）。</p>

<h2 id="总结"><span class="me-2">总结</span><a href="#总结" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>本文首先介绍了以太坊 PoS 共识协议中重要的术语和概念，并深入讲解了分叉选择规则 LMD GHOST 的机制和原理。后续文章将继续介绍 Casper FFG，以及两者结合的 Gasper，并将探讨以太坊共识协议实现中存在问题及解决方法。</p>

<hr />

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>注意这一点有助于我们评估以太坊的去中心化程度。比如网络上有 500000 个活跃的验证者远不能代表网络有 500000 个独立的参与者。节点数量以及验证者在节点间分布情况，是更能衡量以太坊去中心化程度的指标。 <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://beaconcha.in/">Beaconcha.in</a> 显示了每个 Epoch 的见证参与率（也叫投票参与率），这是衡量网络运行状况的一个很好的指标。参与率通常都超过了 99%，对大规模分布式共识协议来说是十分出色的水平。 <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>即常说的 “nothing at stake”（利益无关）问题。 <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/blockchain/">Blockchain</a>,
          <a href="/categories/ethereum/">Ethereum</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/ethereum/"
            class="post-tag no-text-decoration"
          >ethereum</a>
        
          <a
            href="/tags/pos/"
            class="post-tag no-text-decoration"
          >pos</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=%E4%BB%A5%E5%A4%AA%E5%9D%8A%20PoS%20%E5%85%B1%E8%AF%86%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%20LMD%20GHOST%20-%20Fanwb's%20Blog&url=https%3A%2F%2Ffan-wb.github.io%2Fposts%2Flmdghost%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=%E4%BB%A5%E5%A4%AA%E5%9D%8A%20PoS%20%E5%85%B1%E8%AF%86%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%20LMD%20GHOST%20-%20Fanwb's%20Blog&u=https%3A%2F%2Ffan-wb.github.io%2Fposts%2Flmdghost%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=https%3A%2F%2Ffan-wb.github.io%2Fposts%2Flmdghost%2F&text=%E4%BB%A5%E5%A4%AA%E5%9D%8A%20PoS%20%E5%85%B1%E8%AF%86%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%20LMD%20GHOST%20-%20Fanwb's%20Blog" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/avalanche/">Avalanche 共识协议详解</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ava9000/">Avalanche9000 升级总览</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ml1ga/">Make L1 Great Again</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/stablecoin/">稳定币：金融生态的跨界之桥</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/aa/">账户抽象架构设计详解</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ethereum/">ethereum</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/consensus/">consensus</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/privacy/">privacy</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rollup/">rollup</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/blockchain/">blockchain</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/avalanche/">avalanche</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/defi/">defi</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ipfs/">ipfs</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/l1/">l1</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pos/">pos</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/casperffg/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1684641600"
  data-df="ll"
  
>
  May 21, 2023
</time>

              <h4 class="pt-0 my-2">以太坊 PoS 共识协议详解（二）：Casper FFG</h4>
              <div class="text-muted">
                <p>
                  





                  本文是介绍以太坊 PoS 共识协议的第二部分，主要对最终性工具 Casper FFG 进行全面说明。

许多文章都介绍过 Casper FFG 的运行机制，但很少解释这些机制为什么有效。希望本文能为读者理解 Casper FFG 的有效性提供一些参考。

总体而言，Casper FFG 的机制并不复杂，其有效性主要归功于为两个重要理念：两阶段提交，以及可问责安全性。

两阶段提交赋予了 Ca...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/ethds/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1695096000"
  data-df="ll"
  
>
  Sep 19, 2023
</time>

              <h4 class="pt-0 my-2">以太坊数据结构详解</h4>
              <div class="text-muted">
                <p>
                  





                  以太坊的实现中涉及了多种数据结构和编码规则，全面深入地理解这些内容对研究者和开发者来说至关重要。目前，该领域的主要信息来源是以太坊黄皮书、以太坊开发者文档以及网络上大量的非正式博客文章。黄皮书内容全面，但难称详略得当，易读性较低，且省略了智能合约数据的结构和存储信息。以太坊开发者文档的内容组织散乱，依赖众多外部博客和视频链接的补充完善。以太坊创始人 Antonopoulos 和 Wood 出...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/001/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1649908800"
  data-df="ll"
  
>
  Apr 14, 2022
</time>

              <h4 class="pt-0 my-2">工作量证明机制下以太坊中一笔交易的完整流程</h4>
              <div class="text-muted">
                <p>
                  





                  
  
    用户编写并使用账户私钥签署交易请求。
  
  
    用户通过节点将自己的交易请求广播到整个以太坊网络。
  
  
    每个接收到新交易请求的以太坊网络节点会将此交易添加到其本地的内存池。内存池主要用来存储该节点已收到的、还未被添加到区块链的区块中被承认的所有交易请求。
  
  
    在某一时间点，挖矿节点以特定方式将几十或上百个交易请求汇总到一个潜在区块中，...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/floo/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>文件同步系统 Floo 基本功能演示</p>
    </a>
  

  
    <a
      href="/posts/casperffg/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>以太坊 PoS 共识协议详解（二）：Casper FFG</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->

  
  <!-- https://giscus.app/ -->
<script type="text/javascript">
  (function () {
    const origin = 'https://giscus.app';
    const iframe = 'iframe.giscus-frame';
    const lightTheme = 'light';
    const darkTheme = 'dark_dimmed';

    let initTheme = lightTheme;
    const html = document.documentElement;

    if (
      (html.hasAttribute('data-mode') &&
        html.getAttribute('data-mode') === 'dark') ||
      (!html.hasAttribute('data-mode') &&
        window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      initTheme = darkTheme;
    }

    let giscusAttributes = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'fan-wb/fan-wb.github.io',
      'data-repo-id': 'R_kgDOIpbGbQ',
      'data-category': 'Announcements',
      'data-category-id': 'DIC_kwDOIpbGbc4CimRo',
      'data-mapping': 'pathname',
      'data-reactions-enabled': '1',
      'data-emit-metadata': '0',
      'data-theme': initTheme,
      'data-input-position': 'top',
      'data-lang': 'zh-CN',
      'data-loading': 'lazy',
      crossorigin: 'anonymous',
      async: ''
    };

    let giscusScript = document.createElement('script');
    Object.entries(giscusAttributes).forEach(([key, value]) =>
      giscusScript.setAttribute(key, value)
    );
    document.getElementById('tail-wrapper').appendChild(giscusScript);

    addEventListener('message', (event) => {
      if (
        event.source === window &&
        event.data &&
        event.data.direction === ModeToggle.ID
      ) {
        /* global theme mode changed */
        const mode = event.data.message;
        const theme = mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme;

        const message = {
          setConfig: {
            theme: theme
          }
        };

        const giscus = document.querySelector(iframe).contentWindow;
        giscus.postMessage({ giscus: message }, origin);
      }
    });
  })();
</script>



            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2024</time>

    
      <a href="https://github.com/fan-wb">Fan-WB</a>.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title=""
      ><a href='https://beian.miit.gov.cn/' target='_blank'>京ICP备2024091746号-1</a></span>
    
  </p>

  <p>Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ethereum/">ethereum</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/consensus/">consensus</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/privacy/">privacy</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/rollup/">rollup</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/blockchain/">blockchain</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/avalanche/">avalanche</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/defi/">defi</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/ipfs/">ipfs</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/l1/">l1</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pos/">pos</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->




  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>


  <!-- MathJax -->
  <script>
    /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */
    MathJax = {
      tex: {
        /* start/end delimiter pairs for in-line math */
        inlineMath: [
          ['$', '$'],
          ['\\(', '\\)']
        ],
        /* start/end delimiter pairs for display math */
        displayMath: [
          ['$$', '$$'],
          ['\\[', '\\]']
        ],
        /* equation numbering */
        tags: 'ams'
      }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script>





    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

